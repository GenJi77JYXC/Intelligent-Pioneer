# Intelligent-Pioneer Agent 目录结构说明

本文档旨在详细解释 `Intelligent-Pioneer` 终端智能体 (Agent) 的代码目录结构、设计理念以及各个模块的核心职责。

## 顶层设计理念

Agent 被设计为一个独立的、高内聚的 Go 应用程序。其内部结构遵循“关注点分离 (Separation of Concerns)”原则，将不同的功能逻辑（如配置管理、API通信、任务执行）解耦到各自的包中，以提高代码的可读性、可测试性和可维护性。

## 目录结构概览

agent/
├── cmd/
│   └── agent/
│       └── main.go           # 1. 程序主入口
├── docs/
│   └── 目录结构.md         
├── internal/
   ├── client/               # 2. API 客户端 (负责与后端通信)
   │   └── client.go
   ├── config/               # 3. 配置管理
   │   └── config.go
   ├── executor/             # 4. 命令执行器
   │   └── executor.go
   ├── heartbeat/            # 5. 心跳服务
   │   └── heartbeat.go
   ├── sysinfo/              # 6. 系统信息采集
   │   └── sysinfo.go
   └── task/                 # 7. 任务拉取与处理
       └── task.go
---

## 各模块职责详解

### 1. `cmd/agent/main.go`
- **职责:** Agent 应用程序的**唯一启动入口**。
- **核心工作:**
    - 初始化程序（加载配置、初始化日志等）。
    - 启动核心的服务协程（如心跳服务、任务拉取服务）。
    - 监听操作系统信号，实现优雅关停 (Graceful Shutdown)。
- **原则:** 此文件应保持尽可能的简洁，只做“组装”和“启动”的工作，不包含具体的业务逻辑。

### 2. `internal/client/`
- **职责:** **封装所有与后端 `intelligent-pioneer` API 的 HTTP 通信**。
- **核心工作:**
    - 提供类型安全的方法（如 `Register()`, `SendHeartbeat()`, `FetchTasks()`）来调用后端 API。
    - 处理 HTTP 请求的创建、发送、超时控制以及响应的解析和错误处理。
    - 定义与后端 API 交互所需的数据结构（Request/Response Body）。
- **原则:** 项目中任何需要与后端交互的部分，都应该通过这个包提供的方法，而不是直接调用 `http.Post` 等原生方法。

### 3. `internal/config/`
- **职责:** **管理 Agent 的本地配置**。
- **核心工作:**
    - 定义 Agent 的配置结构体。
    - 从本地文件（如 `~/.intelligent-pioneer/agent_config.json`）加载配置。
    - 将运行时获取到的配置（如从服务器获取的 `AgentID`）持久化到本地文件。
- **原则:** 提供一个全局可访问的配置实例，供其他模块读取配置信息。

### 4. `internal/executor/`
- **职责:** **安全、可靠地执行从后端下发的命令**。
- **核心工作:**
    - 使用 `os/exec` 执行 shell 命令。
    - 实现命令执行的超时控制 (Context Timeout)。
    - 捕获命令的标准输出 (stdout)、标准错误 (stderr) 和退出码 (exit code)。
    - 将执行结果封装成统一的 `TaskResult` 结构体。
- **原则:** 这是 Agent “动手能力”的核心，必须保证其稳定性和安全性。

### 5. `internal/heartbeat/`
- **职责:** **周期性地向后端发送心跳**，以表明 Agent 存活。
- **核心工作:**
    - 包含一个 `Start()` 函数，在一个独立的 goroutine 中运行。
    - 使用 `time.Ticker` 来实现定时任务。
    - 在循环中调用 `client` 包的 `SendHeartbeat` 方法。
    - 能够响应 `context.Context` 的取消信号，以实现优雅退出。

### 6. `internal/sysinfo/`
- **职责:** **采集本机的基础系统信息**。
- **核心工作:**
    - 提供获取操作系统信息（名称、版本）、本机 IP 地址、主机名等功能。
    - 封装了对 `gopsutil` 等第三方库的调用，对上层逻辑屏蔽了实现细节。
- **原则:** 提供简单、可靠的接口，供注册等流程调用。

### 7. `internal/task/`
- **职责:** **拉取、调度和处理来自后端的任务**。
- **核心工作:**
    - 包含一个 `StartPolling()` 函数，在独立的 goroutine 中通过长轮询 (Long Polling) 方式循环调用 `client` 包的 `FetchTasks` 方法。
    - 当获取到新任务时，**异步地**调用 `executor` 包来执行任务。
    - 任务执行完毕后，调用 `client` 包的 `PostResult` 方法上报结果。
- **原则:** 这是 Agent 的“主循环”，负责驱动所有自动化任务的执行。异步执行任务是关键，以避免阻塞后续任务的拉取。
